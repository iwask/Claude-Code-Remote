services:
  # Discord Webhook Server - メイン通知受信サービス
  discord-webhook:
    build: .
    container_name: claude-code-discord-webhook
    restart: unless-stopped
    ports:
      - "${DISCORD_WEBHOOK_PORT:-3023}:${DISCORD_WEBHOOK_PORT:-3023}"
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      # セッション管理用の永続化
      - ./src/data/sessions:/app/src/data/sessions
      # ログの永続化
      - ./logs:/app/logs
      # tmuxソケットをマウント（ホストのtmuxと連携）
      - /tmp/tmux-${UID:-1000}:/tmp/tmux-${UID:-1000}
    networks:
      - claude-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:${DISCORD_WEBHOOK_PORT:-3023}/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    command: node start-discord-webhook.js

  # Telegram Webhook Server (オプション)
  telegram-webhook:
    build: .
    container_name: claude-code-telegram-webhook
    restart: unless-stopped
    ports:
      - "${TELEGRAM_WEBHOOK_PORT:-3005}:${TELEGRAM_WEBHOOK_PORT:-3005}"
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      - ./sessions:/app/sessions
      - ./logs:/app/logs
      - /tmp/tmux-${UID:-1000}:/tmp/tmux-${UID:-1000}
    networks:
      - claude-network
    profiles:
      - telegram
    command: node start-telegram-webhook.js

  # Line Webhook Server (オプション)
  line-webhook:
    build: .
    container_name: claude-code-line-webhook
    restart: unless-stopped
    ports:
      - "${LINE_WEBHOOK_PORT:-3000}:${LINE_WEBHOOK_PORT:-3000}"
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      - ./sessions:/app/sessions
      - ./logs:/app/logs
      - /tmp/tmux-${UID:-1000}:/tmp/tmux-${UID:-1000}
    networks:
      - claude-network
    profiles:
      - line
    command: node start-line-webhook.js

networks:
  claude-network:
    driver: bridge

volumes:
  sessions:
  logs:
